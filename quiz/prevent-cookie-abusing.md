---
layout  : wiki
title   : 
summary : 
date    : 2022-08-23 20:45:26 +0900
updated : 2022-08-23 20:45:35 +0900
tags    : 
toc     : true
public  : true
parent  : 
latex   : false
---
* TOC
{:toc}

# 
## 퀴즈 답변
서버는 추후 클라이언트 식별을 위해 클라이언트가 보낸 요청 헤더 안 Client-IP 값과 User-Agent 값을 DB에 저장합니다. 
1) 처음으로 클라이언트가 사이트를 방문할 때 클라이언트는 서버에 요청을 보냅니다.
2) 요청 헤더 안 Client-IP에는 클라이언트의 IP 주소 정보가 적혀있고, User-Agent에는 클라이언트가 사용하고 있는 애플리케이션(브라우저) 이름이 적혀 있습니다.
3) 이들 값을 바로 저장하지 않고 암호화해서 저장합니다. (암호화된 IP값, 암호화된 User-Agent값)
4) 추가로, UV 카운팅 로직을 통해 얻은 이 클라이언트의 UV 값도 DB에 저장합니다.
5) 그러면 DB에는 이 클라이언트 정보가 암호화된 IP값, 암호화된 User-Agent값, UV 카운트로 저장됩니다.

만약 사용자가 방문횟수를 어뷰징할 목적으로 쿠키를 다시 만들어 보내려고 하는 경우, 서버는 다음과 같이 대처합니다.
1) 서버는 사용자가 새로 쿠키를 만들어 서버에 보낼 때 온 요청 헤더를 확인합니다.
2) 여기에 들어있는 Client-IP와 User-Agent 값을 암호화해보고 DB에 있는 데이터 중 일치하는 것이 있는지 확인합니다.
User-Agent를 확인함으로써 같은 IP라도 사용자가 다른 브라우저로 접속할 가능성을 차단합니다.
4) 만약 DB에 일치하는 IP 및 User-Agent 값이 있다면 이미 카운팅된 클라이언트이므로 UV 카운팅을 하지 않습니다.

## 퀴즈 조사 방향 질문
‘온라인 명함 서비스’는 누구나 링크를 통해서 보험 설계사의 정보를 확인하고 상담신청 할 수 있는 웹서비스 입니다. 온라인 명함 서비스를 널리 알리기 위해서 온라인 명함 *UV(Unique Visitor) 100회 당 행운상자를 제공하는 이벤트를 만들었습니다.
해당 이벤트는 쿠키 기반으로 UV 카운팅하는 로직을 구현했습니다. 서버에서 쿠키를 발급하고 해당 쿠키를 가진 브라우저의 요청은 하루에 한 번만 카운팅 되도록 했습니다.
그런데 쿠키는 브라우저에서 쉽게 조작할 수 있습니다. 쿠키가 없는 요청은 새 쿠키가 발급되는 것을 이용하여, 조회수를 쉽게 늘리는 어뷰징이 가능한 상황입니다. 이 어뷰징을 막기 위해서 어떤 방법이 있을지 작성해 주세요.
UV(Unique Visitor): 측정 기간 동안 중복을 제거한 순방문자 수 / 사용자수, 조회 기간에 방문한 유니크한 사람의 수


안녕하세요. 쿠키 퀴즈를 풀려고 여러 방향으로 생각해봤는데, 어떻게 조사하면 좋을지 방향이 잘 안서는 것 같다는 생각이 들었습니다. 지금까지 찾아보고 고민해봤던 내용을 정리하고 조사 방향을 질문드립니다.

0. 처음으로, 어뷰징 발생 상황을 생각해봤습니다.
1) 사이트에서는 100번째마다 들어온 방문자에게 선물을 주려고 한다.
2) 100번째에 들어오지 않은 방문자도 선물을 받고 싶다.
3) 이 방문자는 쿠키를 지우고 다시 발급받는 걸 반복해서 UV 카운팅을 늘려 마치 다음 100번째 방문자인 척을 해 행운상자를 받는다.

1. 질문에서는 "서버에서 쿠키를 발급하고 해당 쿠키를 가진 브라우저의 요청은 하루에 한 번만 카운팅"하도록 구현했다고 합니다.
그래서 이 다음으로 쿠키 기반으로 UV를 카운팅할 때 사용자가 쿠키를 조작하지 않고도 UV가 영향을 받는 상황을 조사하고 고민해 보았습니다.
1) 브라우저로 방문 후 하루 지나서 동일한 브라우저로 방문하면 카운팅이 늘어납니다.
2) 쿠키는 브라우저마다도 다르므로 다른 브라우저로 접속하면 같은 사용자여도 UV가 늘어납니다.
3) 사용자가 기기를 변경해서 IP가 바뀌면 같은 사용자여도 UV가 늘어납니다.
4) 사용자가 쿠키를 수집하는 것을 거부하면 쿠키를 기반으로 UV를 카운팅할 수 없습니다.
- 위와 같은 상황은 고려하지 않아도 괜찮은가 하는 의문이 들었습니다.
https://www.beusable.net/blog/?p=3781
https://mindthelog.com/2017/01/unique-visitor-cookies-discrepancy/

2. 몇 가지 어뷰징 방지 방안 아이디어와 세부 사항을 고민해봤습니다.
I. 사용자가 쿠키를 새로 발급할 수 없도록 하는 아이디어
- 위와 같은 쿠키 종류나 속성이 있는지 찾아보았습니다.
1) persistent cookie는 세션과 관계없이 특정 기간이나 특정 시점까지 유효합니다.
2) Secure 속성이 명시된 쿠키는 브라우저가 https 프로토콜을 쓰는 경우에만 쿠키를 보냅니다.
3) HttpOnly 속성이 명시된 쿠키는 브라우저에서 자바스크립트로 Document.cookie 객체를 통해 접근할 수 없습니다.
- 하지만 이 중 어떤 것도 사용자가 쿠키를 삭제하는 것을 막을 수는 없습니다. 따라서 이 방안은 사용할 수 없다고 판단했습니다.

II. 쿠키가 유효한지 검증하는 아이디어
1) 쿠키를 만들 때 카운팅 관련 값을 암호화합니다
2) 이후 브라우저가 쿠키를 전달했을 때 그 값이 달라졌는지를 확인합니다
3) 달라졌다면 어뷰징으로 판단합니다
- 하지만 사용자가 쿠키를 삭제하면 비교할 수 있는 정보가 아예 사라집니다. 따라서 이 방안은 사용할 수 없다고 판단했습니다.

I와 II에서 결론을 내린 후, 쿠키가 없어지더라도 어뷰징을 방지할 수 있는 방법을 찾아야 할 것 같다고 생각했습니다.

III. 어뷰징을 막기 위해 카운팅에 필요한 정보를 저장해놓는 아이디어
가. 어떤 정보를 저장해야 하나?
1) 사용자 식별 정보
- 사용자의 IP나 사용자의 ID를 사용자 식별 정보로 사용할 수 있을 것 같습니다.
- 하지만 IP를 저장하면 개인 정보를 저장한다는 문제점이 있습니다. 이 이슈를 피할 수 있는 방법은 찾지 못했습니다.
2) 사용자 첫 방문 시점 정보
- 첫 방문 시점과 같은 날이고 다른 시간이라면, 카운팅되지 말아야 할 정보입니다.
- UV 카운팅 로직에서 이 정보를 이용할 수도 있다고 생각합니다. 하지만 쿠키를 이용해서 카운팅 로직을 구현하고, 다른 저장소를 이용한다는 이야기는 없었습니다. 만약 쿠키에 방문 시점 정보를 관리하고 있다면, 쿠키가 삭제될 경우 어뷰징 방지에 활용할 수 없을 것이고, 그래서 필요할 것이라고 생각했습니다.
3) 사용자 방문 번째수 (몇번째로 들어왔는지)
- 클라이언트의 방문 번째수가 (어딘가에 저장된 처음의) 방문 번째수와 다르다면 어뷰징한 것을 확인할 수 있을 것 같습니다.

나. 각 정보는 어디에 저장할 수 있나?
- 사용자가 누구인지 기억해두고 쿠키 재발급에 관계 없이 동일한 사용자이면 UV 카운팅하지 않도록 하려면 어디에 담아야 할까 고민했습니다.
1) 쿠키
- 쿠키에 담을 경우 사용자가 변경하거나 삭제할 수 있으므로 카운트 정보가 쉽게 바뀔 수 있습니다.
2) 이외에 세션, 로컬 스토리지, 세션 스토리지, DB를 생각해봤습니다.
- 이 부분은 아직 조사하지 않았습니다.
- 쿠키 이외의 저장 공간을 사용하게 되면 이를 유지하기 위한 자원을 유지 및 관리하는 문제점이 있습니다. 이 이슈도 조사하지 않았습니다.

현재까지의 상황은 이렇습니다.
멘토링 후 "완벽하게 방지하는 것이 아니라"는 말씀을 듣고 난 뒤 정리하면서 보니 답변에 활용할 수 있을만한 부분이 몇몇 눈에 띄었습니다. 하지만 "알아본 내용으로 퀴즈에 답변할 수 있는 형태로 만들 수 있는가?"에는 그다지 긍정적이지 않다고 생각합니다. 개인적으로 "실제로 구현할 수 있는가"가 확실치 않아서 그런 게 아닌가 생각이 듭니다.
앞으로는 멘토링 때 말씀해주셨던 키워드(prevent cookie stealing, UserAgent)와 위에서 아직 조사하지 않은 부분(아이디어 III. 나. 중 2번 항목)을 추가로 알아보려고 합니다. 혹시 멘토님이 보시기에 더 알아보면 좋을 내용이 있으시다면 알려주실 수 있을까요?
